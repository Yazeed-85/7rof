<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø´Ø§Ø´Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨</title>
    <style>
        /* Ù…Ù†Ø¹ Ø£ÙŠ Ù‡ÙˆØ§Ù…Ø´ Ø¥Ø¶Ø§ÙÙŠØ© */
        * { box-sizing: border-box; margin: 0; padding: 0; }

        body { 
            font-family: sans-serif; 
            background-color: #1e293b; 
            color: white; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            height: 100vh; 
            width: 100%; 
            overflow: hidden; 
            /* ØªØ­Ø³ÙŠÙ† Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ù„Ù…Ø³ ÙˆÙ…Ù†Ø¹ Ø§Ù„ØªÙƒØ¨ÙŠØ± */
            touch-action: manipulation;
        }
        
        #colorModal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.95); display: flex; justify-content: center; align-items: center; z-index: 1000; flex-direction: column; gap: 25px;}
        .team-btn { border: none; padding: 25px 50px; font-size: 1.8rem; font-weight: bold; border-radius: 15px; color: white; cursor: pointer; width: 85%; max-width: 350px; box-shadow: 0 10px 20px rgba(0,0,0,0.3); transition: transform 0.2s; touch-action: manipulation;}
        .team-btn:active { transform: scale(0.95); }
        .btn-green { background-color: #4CAF50; border: 4px solid #2E7D32; }
        .btn-orange { background-color: #FF9800; border: 4px solid #E65100; }

        #gameScreen { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; transition: background-color 0.2s; }
        
        .status-container { width: 100%; display: flex; flex-direction: column; background: rgba(0,0,0,0.6); z-index: 10; box-shadow: 0 4px 10px rgba(0,0,0,0.2);}
        .connection-bar { display: flex; justify-content: center; align-items: center; gap: 8px; padding: 5px; font-size: 0.9rem; background: #0f172a;}
        .dot { width: 12px; height: 12px; border-radius: 50%; background-color: #ef4444; box-shadow: 0 0 8px #ef4444;}
        .dot.online { background-color: #10b981; box-shadow: 0 0 8px #10b981;}
        .status-bar { padding: 15px; text-align: center; font-size: 1.4rem; font-weight: bold; }
        
        .big-buzzer { 
            flex: 1; 
            width: 90%; 
            max-width: 600px; 
            margin: 20px auto; 
            border-radius: 30px; 
            border: none; 
            font-size: 3.5rem; 
            font-weight: bold; 
            color: white; 
            cursor: pointer; 
            box-shadow: 0 15px 25px rgba(0,0,0,0.4); 
            transition: transform 0.1s, background-color 0.3s; 
            
            /* Ø£Ø³Ø±Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„Ù„Ù…Ø³: Ù†Ù„ØºÙŠ Ø£ÙŠ ØªØ£Ø®ÙŠØ± Ù„Ù„Ù…ØªØµÙØ­ */
            touch-action: none; 
            -webkit-tap-highlight-color: transparent;
            user-select: none; 
            -webkit-user-select: none;
        }
        .big-buzzer:active { transform: scale(0.95); }
        .big-buzzer:disabled { opacity: 0.5; cursor: not-allowed; transform: scale(1); }
        .big-buzzer.penalty { background-color: #334155 !important; border: 4px dashed #ef4444; color: #ef4444; opacity: 1;}

        .iframe-container { 
            width: 95%; max-width: 600px; 
            height: 45vh; min-height: 350px; 
            margin: 0 auto 20px auto; 
            overflow: hidden; background: transparent; border: none;
            display: flex; justify-content: center; align-items: center;
        }
        iframe { width: 100%; height: 100%; border: none; }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB5CobIKfYdAz8jaabJpMQrGoqS9Ton28Y",
            authDomain: "buttons-f3501.firebaseapp.com",
            databaseURL: "https://buttons-f3501-default-rtdb.firebaseio.com",
            projectId: "buttons-f3501"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const urlParams = new URLSearchParams(window.location.search);
        const pin = urlParams.get('pin');
        
        let myTeamId = "";
        let myColor = "";
        let myTeamName = "";
        let serverTimeOffset = 0;
        let currentState = null;

        const buzzerRef = ref(db, `rooms/${pin}/buzzer`);
        const statusBar = document.getElementById('statusBar');
        const gameScreen = document.getElementById('gameScreen');
        const buzzerBtn = document.getElementById('buzzerBtn');
        const connDot = document.getElementById('connDot');
        const connText = document.getElementById('connText');

        document.getElementById('gridFrame').src = `letters.html?pin=${pin}&role=player`;

        onValue(ref(db, ".info/connected"), (snap) => {
            if (snap.val() === true) {
                connDot.classList.add('online');
                connText.innerText = "Ù…ØªØµÙ„";
                connText.style.color = "#10b981";
            } else {
                connDot.classList.remove('online');
                connText.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...";
                connText.style.color = "#ef4444";
            }
        });

        onValue(ref(db, ".info/serverTimeOffset"), (snap) => {
            serverTimeOffset = snap.val() || 0;
        });
        function getServerTime() { return Date.now() + serverTimeOffset; }

        window.selectTeam = function(id, colorHex, teamName) {
            myTeamId = id;
            myColor = colorHex;
            myTeamName = teamName;
            
            document.getElementById('colorModal').style.display = 'none';
            gameScreen.style.display = 'flex';
            buzzerBtn.style.backgroundColor = myColor;
            buzzerBtn.innerText = teamName;
            statusBar.innerText = "ğŸŸ¢ Ø§Ù†Ø·Ù„Ù‚!"; 
        };

        onValue(buzzerRef, (snapshot) => {
            if (snapshot.exists()) {
                currentState = snapshot.val();
                updateUI();
            }
        });

        function updateUI() {
            if (!currentState || !myTeamId) return;

            if (currentState.status === 'buzzed') {
                buzzerBtn.disabled = true;
                buzzerBtn.classList.remove('penalty');
                gameScreen.style.backgroundColor = currentState.buzzedColor;
            } 
            else if (currentState.status === 'waiting') {
                gameScreen.style.backgroundColor = "#1e293b";
                buzzerBtn.disabled = false;
                buzzerBtn.classList.remove('penalty');
                buzzerBtn.innerText = myTeamName;
                statusBar.innerText = "ğŸŸ¢ Ø§Ù†Ø·Ù„Ù‚!";
            }
            else if (currentState.status === 'penalty') {
                gameScreen.style.backgroundColor = "#1e293b";
                
                if (currentState.lockedTeam === myTeamId) {
                    buzzerBtn.disabled = true;
                    buzzerBtn.classList.add('penalty');
                    statusBar.innerText = `âš ï¸ Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©! Ø¹Ù‚ÙˆØ¨Ø©`;
                } else {
                    buzzerBtn.disabled = false;
                    buzzerBtn.classList.remove('penalty');
                    buzzerBtn.innerText = myTeamName;
                    statusBar.innerText = "ğŸ”¥ ÙØ±ØµØ© Ù„Ù„Ø³Ø±Ù‚Ø©! Ø§Ù„Ø®ØµÙ… Ù…Ø¹Ø§Ù‚Ø¨";
                }
            }
        }

        setInterval(() => {
            if (!currentState || !myTeamId) return;
            const now = getServerTime();

            if (currentState.status === 'buzzed') {
                const timeLeft = Math.ceil((currentState.buzzedTime + 5000 - now) / 1000);
                if (timeLeft > 0) {
                    if (currentState.buzzedTeam === myTeamId) {
                        statusBar.innerText = `ğŸ† Ø£Ø¬Ø¨ Ø®Ù„Ø§Ù„: ${timeLeft} Ø«ÙˆØ§Ù†ÙŠ`;
                        buzzerBtn.innerText = "ØªØ­Ø¯Ø« ğŸ¤";
                    } else {
                        statusBar.innerText = `âŒ ${currentState.buzzedTeamName} ÙŠØ¬ÙŠØ¨... (${timeLeft})`;
                        buzzerBtn.innerText = "Ù…ØºÙ„Ù‚";
                    }
                }
            }
            
            if (currentState.status === 'penalty' && currentState.lockedTeam === myTeamId) {
                const timeLeft = Math.ceil((currentState.unlockTime - now) / 1000);
                if (timeLeft > 0) {
                    buzzerBtn.innerText = `Ø¹Ù‚ÙˆØ¨Ø© (${timeLeft})`;
                }
            }
        }, 100);

        window.pressBuzzer = async function() {
            if (buzzerBtn.disabled) return;
            
            // Ù‚ÙÙ„ Ø§Ù„Ø²Ø± Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙˆØ±Ø§Ù‹ Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±
            buzzerBtn.disabled = true;

            try {
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… applyLocally: false Ù„Ù…Ù†Ø¹ ÙˆÙ…ÙŠØ¶ Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„ÙƒØ§Ø°Ø¨
                await runTransaction(buzzerRef, (curr) => {
                    if (curr === null) return curr;
                    if (curr.status === 'waiting') {
                        return { ...curr, status: 'buzzed', buzzedTeam: myTeamId, buzzedTeamName: myTeamName, buzzedColor: myColor, buzzedTime: getServerTime() };
                    }
                    if (curr.status === 'penalty' && curr.lockedTeam !== myTeamId) {
                        return { ...curr, status: 'buzzed', buzzedTeam: myTeamId, buzzedTeamName: myTeamName, buzzedColor: myColor, buzzedTime: getServerTime(), lockedTeam: '', unlockTime: 0 };
                    }
                    return; 
                }, { applyLocally: false });
            } catch (error) {
                buzzerBtn.disabled = false;
            }
        };

        // --- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØµØ§Ø±Ù…Ø© (Bare-metal Events) ---
        
        // Ø¯Ø§Ù„Ø© Ù…ÙˆØ­Ø¯Ø© Ù„Ù„ØªÙ†ÙÙŠØ°ØŒ ØªÙ…Ù†Ø¹ Ø£ÙŠ Ø³Ù„ÙˆÙƒ Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù‚Ø¯ ÙŠØ³Ø¨Ø¨ ØªØ£Ø®ÙŠØ±Ø§Ù‹
        const fireBuzzer = function(e) {
            // Ù…Ù†Ø¹ Ø£ÙŠ ØªÙ…Ø±ÙŠØ± Ø£Ùˆ Ø²ÙˆÙ… Ø£Ùˆ Ù‚ÙˆØ§Ø¦Ù… Ù…Ù†Ø¨Ø«Ù‚Ø©
            if (e && e.cancelable) e.preventDefault(); 
            window.pressBuzzer();
        };

        // 1. Ù„Ù„Ø¬ÙˆØ§Ù„: Ø§Ø³ØªØ¬Ø§Ø¨Ø© ÙÙˆØ±ÙŠØ© Ø¹Ù†Ø¯ Ù…Ù„Ø§Ù…Ø³Ø© Ø§Ù„Ø´Ø§Ø´Ø© (Touchstart)
        // passive: false Ø¶Ø±ÙˆØ±ÙŠØ© Ø¬Ø¯Ø§Ù‹ Ù„Ø¥Ù„ØºØ§Ø¡ ØªØ£Ø®ÙŠØ± Ø§Ù„ØªÙ…Ø±ÙŠØ±
        buzzerBtn.addEventListener('touchstart', fireBuzzer, {passive: false});
        
        // 2. Ù„Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±: Ø§Ø³ØªØ¬Ø§Ø¨Ø© ÙÙˆØ±ÙŠØ© Ø¹Ù†Ø¯ Ù†Ø²ÙˆÙ„ Ø§Ù„Ø²Ø± (Mousedown)
        buzzerBtn.addEventListener('mousedown', function(e) {
            // Ø§Ù„ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø¶ØºØ·Ø© Ø¨Ø§Ù„Ø²Ø± Ø§Ù„Ø£ÙŠØ³Ø± ÙÙ‚Ø·
            if (e.button === 0) fireBuzzer(e);
        });
        
    </script>
</head>
<body>
    <div id="colorModal">
        <h1 style="color:white; margin:0;">Ø§Ø®ØªØ± ÙØ±ÙŠÙ‚Ùƒ</h1>
        <button class="team-btn btn-green" onclick="selectTeam('green', '#4CAF50', 'Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø®Ø¶Ø±')">Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø®Ø¶Ø±</button>
        <button class="team-btn btn-orange" onclick="selectTeam('orange', '#FF9800', 'Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ')">Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ</button>
    </div>

    <div id="gameScreen">
        <div class="status-container">
            <div class="connection-bar">
                <div class="dot" id="connDot"></div>
                <span id="connText">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</span>
            </div>
            <div class="status-bar" id="statusBar">ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ±ÙŠÙ‚...</div>
        </div>
        
        <button id="buzzerBtn" class="big-buzzer"></button>
        
        <div class="iframe-container">
            <iframe id="gridFrame"></iframe>
        </div>
    </div>
</body>
</html>

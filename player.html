<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø´Ø§Ø´Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨</title>
    <style>
        body { font-family: sans-serif; background-color: #1e293b; color: white; margin: 0; display: flex; flex-direction: column; align-items: center; height: 100vh; overflow: hidden;}
        #colorModal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; z-index: 1000; flex-direction: column; gap: 20px;}
        .team-btn { border: none; padding: 25px 50px; font-size: 1.8rem; font-weight: bold; border-radius: 15px; color: white; cursor: pointer; width: 80%; max-width: 300px; box-shadow: 0 10px 20px rgba(0,0,0,0.3);}
        .btn-green { background-color: #4CAF50; border: 3px solid #388E3C; }
        .btn-orange { background-color: #FF9800; border: 3px solid #F57C00; }
        #gameScreen { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; }
        .status-bar { width: 100%; padding: 15px; text-align: center; font-size: 1.2rem; font-weight: bold; background: rgba(0,0,0,0.5); z-index: 10;}
        .big-buzzer { flex: 1; width: 90%; margin: 15px; border-radius: 30px; border: none; font-size: 3rem; font-weight: bold; color: white; cursor: pointer; box-shadow: 0 15px 25px rgba(0,0,0,0.4); transition: transform 0.1s;}
        .big-buzzer:active { transform: scale(0.95); }
        .big-buzzer:disabled { opacity: 0.4; cursor: not-allowed; }
        .big-buzzer.penalty { background-color: #475569 !important; border: 3px dashed #ef4444; color: #ef4444;}
        .iframe-container { width: 95%; height: 45vh; margin-bottom: 20px; border-radius: 20px; overflow: hidden; background: white; border: 3px solid #64748b;}
        iframe { width: 100%; height: 100%; border: none; }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, onValue, runTransaction, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB5CobIKfYdAz8jaabJpMQrGoqS9Ton28Y",
            authDomain: "buttons-f3501.firebaseapp.com",
            databaseURL: "https://buttons-f3501-default-rtdb.firebaseio.com",
            projectId: "buttons-f3501"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const urlParams = new URLSearchParams(window.location.search);
        const pin = urlParams.get('pin');
        
        let myTeamId = "";
        let myColor = "";
        let myTeamName = "";
        
        // Ù…Ø±Ø¬Ø¹ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const buzzerRef = ref(db, `rooms/${pin}/buzzer`);
        
        const statusBar = document.getElementById('statusBar');
        const gameScreen = document.getElementById('gameScreen');
        const buzzerBtn = document.getElementById('buzzerBtn');

        document.getElementById('gridFrame').src = `letters.html?pin=${pin}&role=player`;

        window.selectTeam = function(id, colorHex, teamName) {
            myTeamId = id;
            myColor = colorHex;
            myTeamName = teamName;
            
            document.getElementById('colorModal').style.display = 'none';
            gameScreen.style.display = 'flex';
            buzzerBtn.style.backgroundColor = myColor;
            buzzerBtn.innerText = teamName;
        };

        // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø²Ø±
        onValue(buzzerRef, (snapshot) => {
            if (snapshot.exists()) {
                const data = snapshot.val();
                
                // Ø­Ø§Ù„Ø© 1: Ø´Ø®Øµ Ø¶ØºØ· Ø§Ù„Ø²Ø±
                if (data.status === 'buzzed') {
                    buzzerBtn.disabled = true;
                    buzzerBtn.classList.remove('penalty');
                    gameScreen.style.backgroundColor = data.color; // Ø´Ø§Ø´Ø© Ø§Ù„Ø¬Ù…ÙŠØ¹ ØªØªÙ„ÙˆÙ† Ø¨Ù„ÙˆÙ† Ø§Ù„ÙØ§Ø¦Ø²
                    
                    if (data.teamId === myTeamId) {
                        statusBar.innerText = "ğŸ† Ø£Ù†Øª Ø§Ù„Ø£Ø³Ø±Ø¹!";
                        buzzerBtn.innerText = "Ø¥Ø¬Ø§Ø¨Ø©...";
                    } else {
                        statusBar.innerText = `âŒ ${data.teamName} ÙŠØ¬ÙŠØ¨ Ø§Ù„Ø¢Ù†`;
                        buzzerBtn.innerText = "Ù…ØºÙ„Ù‚";
                    }
                } 
                // Ø­Ø§Ù„Ø© 2: Ø§Ù†ØªØ¸Ø§Ø± (Ø§Ù„Ù„Ø¹Ø¨ Ù…ÙØªÙˆØ­)
                else {
                    gameScreen.style.backgroundColor = "#1e293b";
                    
                    // Ù‡Ù„ Ø£Ù†Ø§ Ù…Ø¹Ø§Ù‚Ø¨ØŸ
                    if (data.lockedTeam === myTeamId) {
                        const now = Date.now();
                        // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ (ØªÙ‚Ø±ÙŠØ¨ÙŠ Ø¨Ø³ÙŠØ· Ù„ØªÙØ§Ø¯ÙŠ ØªØ¹Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆÙ‚ÙŠØª)
                        if (data.unlockTime > now) {
                            buzzerBtn.disabled = true;
                            buzzerBtn.classList.add('penalty');
                            buzzerBtn.innerText = "Ø¹Ù‚ÙˆØ¨Ø© â³";
                            statusBar.innerText = "Ø£Ù†Øª Ù…Ø¹Ø§Ù‚Ø¨ Ù…Ø¤Ù‚ØªØ§Ù‹";
                            
                            // Ø¹Ø¯Ø§Ø¯ Ù…Ø­Ù„ÙŠ Ù„ÙÙƒ Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø©
                            setTimeout(() => {
                                // Ù„Ø§ Ù†ÙØ¹Ù„ Ø´ÙŠØ¡ØŒ Ù†Ù†ØªØ¸Ø± ØªØ­Ø¯ÙŠØ« Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ø£Ùˆ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ÙˆÙ‚Øª
                                // Ù„ÙƒÙ† ÙŠÙ…ÙƒÙ†Ù†Ø§ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù‚Ù‚
                            }, data.unlockTime - now);
                        } else {
                            // Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø©
                            buzzerBtn.disabled = false;
                            buzzerBtn.classList.remove('penalty');
                            buzzerBtn.innerText = myTeamName;
                            statusBar.innerText = "Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø©ØŒ Ø§Ù†Ø·Ù„Ù‚!";
                        }
                    } else {
                        // Ù„Ø³Øª Ù…Ø¹Ø§Ù‚Ø¨Ø§Ù‹ ÙˆØ§Ù„Ù„Ø¹Ø¨ Ù…ÙØªÙˆØ­
                        buzzerBtn.disabled = false;
                        buzzerBtn.classList.remove('penalty');
                        buzzerBtn.innerText = myTeamName;
                        statusBar.innerText = "Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¶ØºØ·!";
                    }
                }
            }
        });

        window.pressBuzzer = async function() {
            if (buzzerBtn.disabled) return;
            
            // ØªØ¹Ø·ÙŠÙ„ ÙÙˆØ±ÙŠ Ù…Ø­Ù„ÙŠ
            buzzerBtn.disabled = true;

            try {
                await runTransaction(buzzerRef, (currentData) => {
                    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ùˆ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù†ØªØ¸Ø§Ø±
                    if (currentData === null || currentData.status === 'waiting') {
                        // ØªØ£ÙƒØ¯ Ø£Ù†Ù†ÙŠ Ù„Ø³Øª Ù…Ø¹Ø§Ù‚Ø¨Ø§Ù‹ (Ø£Ù…Ø§Ù† Ø¥Ø¶Ø§ÙÙŠ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±)
                        if (currentData && currentData.lockedTeam === myTeamId && currentData.unlockTime > Date.now()) {
                            return; // Ø§Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
                        }
                        return { 
                            status: 'buzzed', 
                            teamId: myTeamId, 
                            teamName: myTeamName, 
                            color: myColor,
                            lockedTeam: '', // ØªØµÙÙŠØ± Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¹Ù†Ø¯ Ø§Ù„ÙÙˆØ² Ø§Ù„Ø¬Ø¯ÙŠØ¯
                            unlockTime: 0
                        };
                    }
                    return; // Ø´Ø®Øµ Ø¢Ø®Ø± Ø³Ø¨Ù‚
                });
            } catch (error) {
                console.log(error);
                buzzerBtn.disabled = false; // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ ÙÙŠ Ø­Ø§Ù„ Ø§Ù„ÙØ´Ù„
            }
        };
        
        // Ø¯Ø¹Ù… Ø§Ù„Ù„Ù…Ø³
        buzzerBtn.addEventListener('touchstart', function(e) { e.preventDefault(); window.pressBuzzer(); }, {passive: false});

    </script>
</head>
<body>
    <div id="colorModal">
        <h1 style="color:white; margin-bottom: 30px;">Ø§Ø®ØªØ± ÙØ±ÙŠÙ‚Ùƒ</h1>
        <button class="team-btn btn-green" onclick="selectTeam('green', '#4CAF50', 'Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø®Ø¶Ø±')">Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø®Ø¶Ø±</button>
        <button class="team-btn btn-orange" onclick="selectTeam('orange', '#FF9800', 'Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ')">Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ</button>
    </div>

    <div id="gameScreen">
        <div class="status-bar" id="statusBar">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</div>
        <button id="buzzerBtn" class="big-buzzer" onclick="pressBuzzer()"></button>
        <div class="iframe-container">
            <iframe id="gridFrame"></iframe>
        </div>
    </div>
</body>
</html>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø´Ø§Ø´Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨</title>
    <style>
        body { font-family: sans-serif; background-color: #1e293b; color: white; margin: 0; display: flex; flex-direction: column; align-items: center; height: 100vh; overflow: hidden;}
        
        #colorModal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; z-index: 1000; flex-direction: column; gap: 20px;}
        .team-btn { border: none; padding: 25px 50px; font-size: 1.8rem; font-weight: bold; border-radius: 15px; color: white; cursor: pointer; width: 80%; max-width: 300px; box-shadow: 0 10px 20px rgba(0,0,0,0.3);}
        .btn-green { background-color: #4CAF50; border: 3px solid #388E3C; }
        .btn-orange { background-color: #FF9800; border: 3px solid #F57C00; }

        #gameScreen { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; transition: background-color 0.2s; }
        
        .status-bar { width: 100%; padding: 15px; text-align: center; font-size: 1.2rem; font-weight: bold; background: rgba(0,0,0,0.5); z-index: 10;}
        
        .big-buzzer { flex: 1; width: 90%; margin: 15px; border-radius: 30px; border: none; font-size: 3rem; font-weight: bold; color: white; cursor: pointer; box-shadow: 0 15px 25px rgba(0,0,0,0.4); transition: transform 0.1s, opacity 0.3s;}
        .big-buzzer:active { transform: scale(0.95); }
        .big-buzzer:disabled { opacity: 0.4; cursor: not-allowed; transform: scale(1); }
        .big-buzzer.penalty { background-color: #475569 !important; border: 3px dashed #ef4444; color: #ef4444;}

        .iframe-container { width: 95%; height: 45vh; margin-bottom: 20px; border-radius: 20px; overflow: hidden; background: white; border: 3px solid #64748b;}
        iframe { width: 100%; height: 100%; border: none; }
        
        .top-score { width: 100%; display: flex; justify-content: space-around; padding: 10px; background: #0f172a; font-weight: bold;}
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, onValue, runTransaction, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB5CobIKfYdAz8jaabJpMQrGoqS9Ton28Y",
            authDomain: "buttons-f3501.firebaseapp.com",
            databaseURL: "https://buttons-f3501-default-rtdb.firebaseio.com",
            projectId: "buttons-f3501"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const urlParams = new URLSearchParams(window.location.search);
        const pin = urlParams.get('pin');
        
        let myTeamId = "";
        let myColor = "";
        let myTeamName = "";
        
        let serverTimeOffset = 0;
        let currentBuzzerData = null;

        const buzzerRef = ref(db, `rooms/${pin}/buzzer`);
        const scoreRef = ref(db, `rooms/${pin}/score`);
        
        const statusBar = document.getElementById('statusBar');
        const gameScreen = document.getElementById('gameScreen');
        const buzzerBtn = document.getElementById('buzzerBtn');

        document.getElementById('gridFrame').src = `letters.html?pin=${pin}&role=player`;

        // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ÙˆÙ‚Øª
        onValue(ref(db, ".info/serverTimeOffset"), (snap) => {
            serverTimeOffset = snap.val() || 0;
        });
        function getServerTime() { return Date.now() + serverTimeOffset; }

        window.selectTeam = function(id, colorHex, teamName) {
            myTeamId = id;
            myColor = colorHex;
            myTeamName = teamName;
            
            document.getElementById('colorModal').style.display = 'none';
            gameScreen.style.display = 'flex';
            buzzerBtn.style.backgroundColor = myColor;
            buzzerBtn.innerText = teamName;
        };

        // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©
        onValue(scoreRef, (snapshot) => {
            if(snapshot.exists()) {
                const s = snapshot.val();
                document.getElementById('pScoreGreen').innerText = `Ø§Ù„Ø£Ø®Ø¶Ø±: ${s.green||0}`;
                document.getElementById('pScoreOrange').innerText = `Ø§Ù„Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ: ${s.orange||0}`;
            }
        });

        // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø²Ø± ÙˆØ§Ù„Ø¹Ù‚ÙˆØ¨Ø§Øª
        onValue(buzzerRef, (snapshot) => {
            if (snapshot.exists()) {
                currentBuzzerData = snapshot.val();
                checkBuzzerState();
            }
        });

        function checkBuzzerState() {
            if (!currentBuzzerData) return;

            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø´Ø®Øµ Ù…Ø§ Ù‚Ø¯ Ø¶ØºØ· Ø§Ù„Ø²Ø± Ø§Ù„Ø¢Ù†
            if (currentBuzzerData.status === 'buzzed') {
                buzzerBtn.disabled = true;
                buzzerBtn.classList.remove('penalty');
                gameScreen.style.backgroundColor = currentBuzzerData.color;
                
                if (currentBuzzerData.teamId === myTeamId) {
                    statusBar.innerText = "ğŸ† Ø£Ù†Øª Ø§Ù„Ø£Ø³Ø±Ø¹! Ø£Ø¬Ø¨ Ø§Ù„Ø¢Ù†";
                    buzzerBtn.innerText = "ØªØ­Ø¯Ø«...";
                } else {
                    statusBar.innerText = `âŒ ${currentBuzzerData.teamName} ÙŠØ¬ÙŠØ¨ Ø§Ù„Ø¢Ù†`;
                    buzzerBtn.innerText = "Ù…ØºÙ„Ù‚";
                }
            } 
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù†Ø¸Ø§Ù… ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± (Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¶ØºØ·)
            else if (currentBuzzerData.status === 'waiting') {
                gameScreen.style.backgroundColor = "#1e293b";
                
                // Ù‡Ù„ ÙØ±ÙŠÙ‚ÙŠ Ù…Ø¹Ø§Ù‚Ø¨ØŸ
                if (currentBuzzerData.lockedTeam === myTeamId) {
                    const timeLeft = Math.ceil((currentBuzzerData.unlockTime - getServerTime()) / 1000);
                    if (timeLeft > 0) {
                        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø©
                        buzzerBtn.disabled = true;
                        buzzerBtn.classList.add('penalty');
                        statusBar.innerText = `âš ï¸ Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©! Ø¹Ù‚ÙˆØ¨Ø© Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª`;
                    } else {
                        // Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø©
                        unlockMyBuzzer();
                    }
                } else {
                    // ÙØ±ÙŠÙ‚ÙŠ ØºÙŠØ± Ù…Ø¹Ø§Ù‚Ø¨ØŒ Ø£Ùˆ Ø¹Ù‚ÙˆØ¨Ø© Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø¢Ø®Ø±
                    unlockMyBuzzer();
                }
            }
        }

        function unlockMyBuzzer() {
            buzzerBtn.disabled = false;
            buzzerBtn.classList.remove('penalty');
            buzzerBtn.innerText = myTeamName;
            
            if (currentBuzzerData && currentBuzzerData.lockedTeam && currentBuzzerData.lockedTeam !== myTeamId && currentBuzzerData.lockedTeam !== '') {
                const timeLeft = Math.ceil((currentBuzzerData.unlockTime - getServerTime()) / 1000);
                if (timeLeft > 0) {
                    statusBar.innerText = "ğŸ”¥ ÙØ±ØµØ© Ù„Ù„Ø³Ø±Ù‚Ø©! Ø§Ù„Ø®ØµÙ… Ù…Ø¹Ø§Ù‚Ø¨";
                    return;
                }
            }
            statusBar.innerText = "ğŸŸ¢ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¶ØºØ·.. Ø§Ù†Ø·Ù„Ù‚!";
        }

        // Ø­Ù„Ù‚Ø© ØªÙƒØ±Ø§Ø± (Loop) Ù„Ù„ØªØ­ÙƒÙ… Ø¨Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ Ù…Ø­Ù„ÙŠØ§Ù‹
        setInterval(() => {
            if (currentBuzzerData && currentBuzzerData.status === 'waiting' && currentBuzzerData.lockedTeam === myTeamId) {
                const timeLeft = Math.ceil((currentBuzzerData.unlockTime - getServerTime()) / 1000);
                if (timeLeft > 0) {
                    buzzerBtn.innerText = `Ø¹Ù‚ÙˆØ¨Ø© (${timeLeft})`;
                } else {
                    // ÙÙƒ Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø© Ø¨Ù…Ø¬Ø±Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ÙˆÙ‚Øª
                    checkBuzzerState();
                }
            }
        }, 100);

        // Ø¯Ø§Ù„Ø© Ø§Ù„Ø¶ØºØ· Ø§Ù„ØµØ§Ø±Ù…Ø©
        window.pressBuzzer = async function() {
            if (buzzerBtn.disabled) return;
            
            buzzerBtn.disabled = true;
            statusBar.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ â³...";

            try {
                await runTransaction(buzzerRef, (currentData) => {
                    if (currentData === null || currentData.status === 'waiting') {
                        // Ø§Ù„ØªØ£ÙƒØ¯ Ø£Ù†Ù†ÙŠ Ù„Ø³Øª Ù…Ø¹Ø§Ù‚Ø¨Ø§Ù‹ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø£ÙŠØ¶Ø§Ù‹
                        if (currentData && currentData.lockedTeam === myTeamId && currentData.unlockTime > getServerTime()) {
                            return; // Ø£Ø±ÙØ¶ Ø§Ù„Ø¶ØºØ·Ø©
                        }
                        return { status: 'buzzed', teamId: myTeamId, teamName: myTeamName, color: myColor, lockedTeam: '', unlockTime: 0 };
                    }
                    return; // Ø´Ø®Øµ Ø¢Ø®Ø± Ø³Ø¨Ù‚Ù†ÙŠ
                });
            } catch (error) {
                buzzerBtn.disabled = false;
            }
        };

        buzzerBtn.addEventListener('touchstart', function(e) { e.preventDefault(); window.pressBuzzer(); }, {passive: false});

    </script>
</head>
<body>
    <div id="colorModal">
        <h1 style="color:white; margin-bottom: 30px;">Ø§Ø®ØªØ± ÙØ±ÙŠÙ‚Ùƒ</h1>
        <button class="team-btn btn-green" onclick="selectTeam('green', '#4CAF50', 'Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø®Ø¶Ø±')">Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø®Ø¶Ø±</button>
        <button class="team-btn btn-orange" onclick="selectTeam('orange', '#FF9800', 'Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ')">Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ</button>
    </div>

    <div id="gameScreen">
        <div class="top-score">
            <span id="pScoreGreen" style="color:#4CAF50;">Ø§Ù„Ø£Ø®Ø¶Ø±: 0</span>
            <span style="color:#94a3b8;">(Ø§Ù„Ø£ÙØ¶Ù„ Ù…Ù† 3)</span>
            <span id="pScoreOrange" style="color:#FF9800;">Ø§Ù„Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ: 0</span>
        </div>
        
        <div class="status-bar" id="statusBar">ğŸŸ¢ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¶ØºØ·.. Ø§Ù†Ø·Ù„Ù‚!</div>
        
        <button id="buzzerBtn" class="big-buzzer" onclick="pressBuzzer()"></button>

        <div class="iframe-container">
            <iframe id="gridFrame"></iframe>
        </div>
    </div>
</body>
</html>

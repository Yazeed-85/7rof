<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÿ¥ÿßÿ¥ÿ© ÿßŸÑŸÑÿßÿπÿ®</title>
    <style>
        body { font-family: sans-serif; background-color: #1e293b; color: white; margin: 0; display: flex; flex-direction: column; align-items: center; height: 100vh; overflow: hidden;}
        
        #colorModal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.95); display: flex; justify-content: center; align-items: center; z-index: 1000; flex-direction: column; gap: 25px;}
        .team-btn { border: none; padding: 25px 50px; font-size: 1.8rem; font-weight: bold; border-radius: 15px; color: white; cursor: pointer; width: 85%; max-width: 350px; box-shadow: 0 10px 20px rgba(0,0,0,0.3); transition: transform 0.2s;}
        .team-btn:active { transform: scale(0.95); }
        .btn-green { background-color: #4CAF50; border: 4px solid #2E7D32; }
        .btn-orange { background-color: #FF9800; border: 4px solid #E65100; }

        #gameScreen { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; transition: background-color 0.2s; }
        
        /* ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ≠ÿßŸÑÿ© ŸàÿßŸÑÿßÿ™ÿµÿßŸÑ */
        .status-container { width: 100%; display: flex; flex-direction: column; background: rgba(0,0,0,0.6); z-index: 10; box-shadow: 0 4px 10px rgba(0,0,0,0.2);}
        .connection-bar { display: flex; justify-content: center; align-items: center; gap: 8px; padding: 5px; font-size: 0.9rem; background: #0f172a;}
        .dot { width: 12px; height: 12px; border-radius: 50%; background-color: #ef4444; box-shadow: 0 0 8px #ef4444;}
        .dot.online { background-color: #10b981; box-shadow: 0 0 8px #10b981;}
        .status-bar { padding: 15px; text-align: center; font-size: 1.4rem; font-weight: bold; }
        
        .big-buzzer { flex: 1; width: 90%; margin: 20px; border-radius: 30px; border: none; font-size: 3.5rem; font-weight: bold; color: white; cursor: pointer; box-shadow: 0 15px 25px rgba(0,0,0,0.4); transition: transform 0.1s, background-color 0.3s;}
        .big-buzzer:active { transform: scale(0.95); }
        .big-buzzer:disabled { opacity: 0.5; cursor: not-allowed; transform: scale(1); }
        .big-buzzer.penalty { background-color: #334155 !important; border: 4px dashed #ef4444; color: #ef4444; opacity: 1;}

        .iframe-container { width: 95%; height: 45vh; margin-bottom: 20px; border-radius: 20px; overflow: hidden; background: #1a1a1a; border: 4px solid #64748b;}
        iframe { width: 100%; height: 100%; border: none; }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB5CobIKfYdAz8jaabJpMQrGoqS9Ton28Y",
            authDomain: "buttons-f3501.firebaseapp.com",
            databaseURL: "https://buttons-f3501-default-rtdb.firebaseio.com",
            projectId: "buttons-f3501"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const urlParams = new URLSearchParams(window.location.search);
        const pin = urlParams.get('pin');
        
        let myTeamId = "";
        let myColor = "";
        let myTeamName = "";
        let serverTimeOffset = 0;
        let currentState = null;

        const buzzerRef = ref(db, `rooms/${pin}/buzzer`);
        const statusBar = document.getElementById('statusBar');
        const gameScreen = document.getElementById('gameScreen');
        const buzzerBtn = document.getElementById('buzzerBtn');
        const connDot = document.getElementById('connDot');
        const connText = document.getElementById('connText');

        document.getElementById('gridFrame').src = `letters.html?pin=${pin}&role=player`;

        // ŸÖÿ§ÿ¥ÿ± ÿßŸÑÿßÿ™ÿµÿßŸÑ
        onValue(ref(db, ".info/connected"), (snap) => {
            if (snap.val() === true) {
                connDot.classList.add('online');
                connText.innerText = "ŸÖÿ™ÿµŸÑ";
                connText.style.color = "#10b981";
            } else {
                connDot.classList.remove('online');
                connText.innerText = "ÿ¨ÿßÿ±Ÿä ÿßŸÑÿßÿ™ÿµÿßŸÑ...";
                connText.style.color = "#ef4444";
            }
        });

        // ŸÖÿ≤ÿßŸÖŸÜÿ© ÿßŸÑŸàŸÇÿ™
        onValue(ref(db, ".info/serverTimeOffset"), (snap) => {
            serverTimeOffset = snap.val() || 0;
        });
        function getServerTime() { return Date.now() + serverTimeOffset; }

        window.selectTeam = function(id, colorHex, teamName) {
            myTeamId = id;
            myColor = colorHex;
            myTeamName = teamName;
            
            document.getElementById('colorModal').style.display = 'none';
            gameScreen.style.display = 'flex';
            buzzerBtn.style.backgroundColor = myColor;
            buzzerBtn.innerText = teamName;
        };

        // ÿßŸÑÿßÿ≥ÿ™ŸÖÿßÿπ ŸÑÿ≠ÿßŸÑÿ© ÿßŸÑŸÑÿπÿ®ÿ©
        onValue(buzzerRef, (snapshot) => {
            if (snapshot.exists()) {
                currentState = snapshot.val();
                updateUI();
            }
        });

        function updateUI() {
            if (!currentState || !myTeamId) return;

            // 1. ÿ¥ÿÆÿµ ÿ∂ÿ∫ÿ∑ ÿßŸÑÿ≤ÿ± (ÿ™ÿ®ÿØÿ£ 5 ÿ´ŸàÿßŸÜŸä ŸÑŸÑÿ•ÿ¨ÿßÿ®ÿ© ŸÑŸÑÿ¨ŸÖŸäÿπ)
            if (currentState.status === 'buzzed') {
                buzzerBtn.disabled = true;
                buzzerBtn.classList.remove('penalty');
                gameScreen.style.backgroundColor = currentState.buzzedColor;
                // ÿ≥Ÿäÿ™ŸÖ ÿπÿ±ÿ∂ ÿßŸÑÿπÿØÿßÿØ ÿπÿ®ÿ± setInterval
            } 
            // 2. ÿ≠ÿßŸÑÿ© ÿßŸÜÿ™ÿ∏ÿßÿ± ÿπÿßÿØŸäÿ©
            else if (currentState.status === 'waiting') {
                gameScreen.style.backgroundColor = "#1e293b";
                buzzerBtn.disabled = false;
                buzzerBtn.classList.remove('penalty');
                buzzerBtn.innerText = myTeamName;
                statusBar.innerText = "üü¢ ÿßŸÜÿ∑ŸÑŸÇ!";
            }
            // 3. ÿ≠ÿßŸÑÿ© ÿπŸÇŸàÿ®ÿ© ŸÑÿ£ÿ≠ÿØ ÿßŸÑŸÅÿ±ŸäŸÇŸäŸÜ (5 ÿ´ŸàÿßŸÜŸä ÿ£ÿÆÿ±Ÿâ)
            else if (currentState.status === 'penalty') {
                gameScreen.style.backgroundColor = "#1e293b";
                
                if (currentState.lockedTeam === myTeamId) {
                    buzzerBtn.disabled = true;
                    buzzerBtn.classList.add('penalty');
                    statusBar.innerText = `‚ö†Ô∏è ÿ•ÿ¨ÿßÿ®ÿ© ÿÆÿßÿ∑ÿ¶ÿ©! ÿπŸÇŸàÿ®ÿ©`;
                } else {
                    buzzerBtn.disabled = false;
                    buzzerBtn.classList.remove('penalty');
                    buzzerBtn.innerText = myTeamName;
                    statusBar.innerText = "üî• ŸÅÿ±ÿµÿ© ŸÑŸÑÿ≥ÿ±ŸÇÿ©! ÿßŸÑÿÆÿµŸÖ ŸÖÿπÿßŸÇÿ®";
                }
            }
        }

        // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿπÿØÿßÿØÿßÿ™ ŸÖÿ≠ŸÑŸäÿßŸã (ŸÑŸÑÿ•ÿ¨ÿßÿ®ÿ© ŸàŸÑŸÑÿπŸÇŸàÿ®ÿ©)
        setInterval(() => {
            if (!currentState || !myTeamId) return;
            const now = getServerTime();

            // ÿπÿØÿßÿØ ÿßŸÑŸÄ 5 ÿ´ŸàÿßŸÜŸä ŸÑŸÑÿ•ÿ¨ÿßÿ®ÿ© ÿ®ÿπÿØ ÿßŸÑÿ∂ÿ∫ÿ∑
            if (currentState.status === 'buzzed') {
                const timeLeft = Math.ceil((currentState.buzzedTime + 5000 - now) / 1000);
                if (timeLeft > 0) {
                    if (currentState.buzzedTeam === myTeamId) {
                        statusBar.innerText = `üèÜ ÿ£ÿ¨ÿ® ÿÆŸÑÿßŸÑ: ${timeLeft} ÿ´ŸàÿßŸÜŸä`;
                        buzzerBtn.innerText = "ÿ™ÿ≠ÿØÿ´ üé§";
                    } else {
                        statusBar.innerText = `‚ùå ${currentState.buzzedTeamName} Ÿäÿ¨Ÿäÿ®... (${timeLeft})`;
                        buzzerBtn.innerText = "ŸÖÿ∫ŸÑŸÇ";
                    }
                } else {
                    statusBar.innerText = "ÿßŸÜÿ™ŸáŸâ ÿßŸÑŸàŸÇÿ™! ŸÜŸÜÿ™ÿ∏ÿ± ŸÇÿ±ÿßÿ± ÿßŸÑÿ≠ŸÉŸÖ...";
                }
            }
            
            // ÿπÿØÿßÿØ ÿßŸÑŸÄ 5 ÿ´ŸàÿßŸÜŸä ŸÑŸÑÿπŸÇŸàÿ®ÿ©
            if (currentState.status === 'penalty' && currentState.lockedTeam === myTeamId) {
                const timeLeft = Math.ceil((currentState.unlockTime - now) / 1000);
                if (timeLeft > 0) {
                    buzzerBtn.innerText = `ÿπŸÇŸàÿ®ÿ© (${timeLeft})`;
                }
            }
        }, 100);

        // ÿØÿßŸÑÿ© ÿßŸÑÿ∂ÿ∫ÿ∑
        window.pressBuzzer = async function() {
            if (buzzerBtn.disabled) return;
            
            buzzerBtn.disabled = true;

            try {
                await runTransaction(buzzerRef, (curr) => {
                    if (curr === null) return curr;
                    
                    if (curr.status === 'waiting') {
                        return { ...curr, status: 'buzzed', buzzedTeam: myTeamId, buzzedTeamName: myTeamName, buzzedColor: myColor, buzzedTime: getServerTime() };
                    }
                    
                    if (curr.status === 'penalty' && curr.lockedTeam !== myTeamId) {
                        return { ...curr, status: 'buzzed', buzzedTeam: myTeamId, buzzedTeamName: myTeamName, buzzedColor: myColor, buzzedTime: getServerTime(), lockedTeam: '', unlockTime: 0 };
                    }
                    return; 
                });
            } catch (error) {
                buzzerBtn.disabled = false;
            }
        };

        buzzerBtn.addEventListener('touchstart', function(e) { e.preventDefault(); window.pressBuzzer(); }, {passive: false});

    </script>
</head>
<body>
    <div id="colorModal">
        <h1 style="color:white; margin:0;">ÿßÿÆÿ™ÿ± ŸÅÿ±ŸäŸÇŸÉ</h1>
        <button class="team-btn btn-green" onclick="selectTeam('green', '#4CAF50', 'ÿßŸÑŸÅÿ±ŸäŸÇ ÿßŸÑÿ£ÿÆÿ∂ÿ±')">ÿßŸÑŸÅÿ±ŸäŸÇ ÿßŸÑÿ£ÿÆÿ∂ÿ±</button>
        <button class="team-btn btn-orange" onclick="selectTeam('orange', '#FF9800', 'ÿßŸÑŸÅÿ±ŸäŸÇ ÿßŸÑÿ®ÿ±ÿ™ŸÇÿßŸÑŸä')">ÿßŸÑŸÅÿ±ŸäŸÇ ÿßŸÑÿ®ÿ±ÿ™ŸÇÿßŸÑŸä</button>
    </div>

    <div id="gameScreen">
        <div class="status-container">
            <div class="connection-bar">
                <div class="dot" id="connDot"></div>
                <span id="connText">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿßÿ™ÿµÿßŸÑ...</span>
            </div>
            <div class="status-bar" id="statusBar">ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±...</div>
        </div>
        
        <button id="buzzerBtn" class="big-buzzer" onclick="pressBuzzer()"></button>
        
        <div class="iframe-container">
            <iframe id="gridFrame"></iframe>
        </div>
    </div>
</body>
</html>

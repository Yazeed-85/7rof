<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø´Ø§Ø´Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨</title>
    <style>
        body { font-family: sans-serif; background-color: #1e293b; color: white; margin: 0; display: flex; flex-direction: column; align-items: center; height: 100vh; overflow: hidden;}
        
        /* Ù†Ø§ÙØ°Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„ÙˆÙ† */
        #colorModal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; z-index: 1000; flex-direction: column; gap: 20px;}
        .team-btn { border: none; padding: 25px 50px; font-size: 1.8rem; font-weight: bold; border-radius: 15px; color: white; cursor: pointer; width: 80%; max-width: 300px; box-shadow: 0 10px 20px rgba(0,0,0,0.3);}
        .btn-green { background-color: #4CAF50; border: 3px solid #388E3C; }
        .btn-orange { background-color: #FF9800; border: 3px solid #F57C00; }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ù„Ø¹Ø¨ */
        #gameScreen { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; transition: background-color 0.1s; }
        
        .status-bar { width: 100%; padding: 15px; text-align: center; font-size: 1.5rem; font-weight: bold; background: rgba(0,0,0,0.5); z-index: 10;}
        
        .big-buzzer { flex: 1; width: 90%; margin: 20px; border-radius: 30px; border: none; font-size: 3rem; font-weight: bold; color: white; cursor: pointer; box-shadow: 0 15px 25px rgba(0,0,0,0.4); transition: transform 0.1s;}
        .big-buzzer:active { transform: scale(0.95); }
        .big-buzzer:disabled { opacity: 0.5; cursor: not-allowed; }

        .iframe-container { width: 95%; height: 40vh; margin-bottom: 20px; border-radius: 20px; overflow: hidden; background: white; border: 3px solid #64748b;}
        iframe { width: 100%; height: 100%; border: none; }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, onValue, runTransaction, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB5CobIKfYdAz8jaabJpMQrGoqS9Ton28Y",
            authDomain: "buttons-f3501.firebaseapp.com",
            databaseURL: "https://buttons-f3501-default-rtdb.firebaseio.com",
            projectId: "buttons-f3501",
            storageBucket: "buttons-f3501.appspot.com",
            messagingSenderId: "773064924745",
            appId: "1:773064924745:web:a6b2260f7947d64227a998"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Ø¬Ù„Ø¨ Ø§Ù„Ù€ PIN Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
        const urlParams = new URLSearchParams(window.location.search);
        const pin = urlParams.get('pin');
        
        let myColor = "";
        let myTeamName = "";
        let isRoundActive = true;

        const roomWinnerRef = ref(db, `rooms/${pin}/winner`);
        const statusBar = document.getElementById('statusBar');
        const gameScreen = document.getElementById('gameScreen');
        const buzzerBtn = document.getElementById('buzzerBtn');

        // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù€ iframe ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø· Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©
        document.getElementById('gridFrame').src = `letters.html?pin=${pin}&role=player`;

        // Ø¯Ø§Ù„Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ±ÙŠÙ‚
        window.selectTeam = function(colorHex, teamName) {
            myColor = colorHex;
            myTeamName = teamName;
            
            document.getElementById('colorModal').style.display = 'none';
            gameScreen.style.display = 'flex';
            
            buzzerBtn.style.backgroundColor = myColor;
            buzzerBtn.innerText = teamName;
        };

        // Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØµØ§Ø±Ù…Ø© (Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù‚Ø±Ø§Ø± Ø§Ù„Ø³ÙŠØ±ÙØ±)
        onValue(roomWinnerRef, (snapshot) => {
            if (snapshot.exists()) {
                const winnerData = snapshot.val();
                isRoundActive = false;
                buzzerBtn.disabled = true;
                
                // Ù‡Ù†Ø§ ØªØªØºÙŠØ± Ø§Ù„Ø´Ø§Ø´Ø© Ù„Ù„ÙˆÙ† Ø§Ù„ÙØ§Ø¦Ø² Ø¨Ø´ÙƒÙ„ Ù…ÙˆØ­Ø¯ Ù„Ù„Ø¬Ù…ÙŠØ¹
                gameScreen.style.backgroundColor = winnerData.color;
                
                if (winnerData.color === myColor) {
                    statusBar.innerText = "ğŸ† ÙØ±ÙŠÙ‚Ùƒ ÙØ§Ø² Ø¨Ø§Ù„Ø¶ØºØ·Ø©!";
                } else {
                    statusBar.innerText = `âŒ ÙØ§Ø² ${winnerData.team}`;
                }
            } else {
                // Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø© (ØªÙ… Ø§Ù„ØªØµÙÙŠØ± Ù…Ù† Ø§Ù„Ù‡ÙˆØ³Øª)
                isRoundActive = true;
                buzzerBtn.disabled = false;
                gameScreen.style.backgroundColor = "#1e293b";
                statusBar.innerText = "ğŸŸ¢ Ø§Ù„Ø¬ÙˆÙ„Ø© Ù†Ø´Ø·Ø©.. Ø§Ø³ØªØ¹Ø¯ Ù„Ù„Ø¶ØºØ·!";
            }
        });

        // Ø¯Ø§Ù„Ø© Ø§Ù„Ø¶ØºØ· (ØªØ±Ø³Ù„ Ù„Ù„Ø³ÙŠØ±ÙØ± ÙˆÙ„Ø§ ØªØºÙŠØ± Ø§Ù„Ø´Ø§Ø´Ø© Ù…Ø­Ù„ÙŠØ§Ù‹)
        window.pressBuzzer = async function() {
            if (!isRoundActive) return;
            
            // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø± Ù…Ø­Ù„ÙŠØ§Ù‹ Ù„Ù…Ù†Ø¹ Ø§Ù„Ø³Ø¨Ø§Ù…
            buzzerBtn.disabled = true;
            statusBar.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ø§Ù„Ù…Ù„ÙŠ Ø«Ø§Ù†ÙŠØ© â³...";

            try {
                // Ø§Ù„Ø³Ø­Ø± Ù‡Ù†Ø§: Ø§Ù„Ø³ÙŠØ±ÙØ± ÙŠÙ‚Ø¨Ù„ Ø£ÙˆÙ„ Ø·Ù„Ø¨ÙŠØ© ÙÙ‚Ø· ÙˆÙŠØ±ÙØ¶ Ø§Ù„Ø¨Ø§Ù‚ÙŠ
                await runTransaction(roomWinnerRef, (currentData) => {
                    if (currentData === null) {
                        // Ø£Ù†Ø§ Ø§Ù„Ø£ÙˆÙ„! Ø³Ø¬Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙŠ
                        return { color: myColor, team: myTeamName, timestamp: serverTimestamp() };
                    } else {
                        // Ø´Ø®Øµ Ø¢Ø®Ø± Ø³Ø¨Ù‚Ù†ÙŠ (ØªÙØ±ÙØ¶ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©)
                        return; 
                    }
                });
            } catch (error) {
                console.error("Ø®Ø·Ø£:", error);
                buzzerBtn.disabled = false;
            }
        };

        // Ø¯Ø¹Ù… Ø§Ù„Ø¶ØºØ· Ø¨Ø§Ù„Ù„Ù…Ø³ Ø§Ù„Ø³Ø±ÙŠØ¹ Ø¹Ù„Ù‰ Ø§Ù„Ø¬ÙˆØ§Ù„
        buzzerBtn.addEventListener('touchstart', function(e) {
            e.preventDefault();
            window.pressBuzzer();
        }, {passive: false});

    </script>
</head>
<body>
    <div id="colorModal">
        <h1 style="color:white; margin-bottom: 30px;">Ø§Ø®ØªØ± ÙØ±ÙŠÙ‚Ùƒ</h1>
        <button class="team-btn btn-green" onclick="selectTeam('#4CAF50', 'Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø®Ø¶Ø±')">Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø®Ø¶Ø±</button>
        <button class="team-btn btn-orange" onclick="selectTeam('#FF9800', 'Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ')">Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ</button>
    </div>

    <div id="gameScreen">
        <div class="status-bar" id="statusBar">ğŸŸ¢ Ø§Ù„Ø¬ÙˆÙ„Ø© Ù†Ø´Ø·Ø©.. Ø§Ø³ØªØ¹Ø¯ Ù„Ù„Ø¶ØºØ·!</div>
        
        <button id="buzzerBtn" class="big-buzzer" onclick="pressBuzzer()"></button>

        <div class="iframe-container">
            <iframe id="gridFrame"></iframe>
        </div>
    </div>
</body>
</html>